<mxfile host="app.diagrams.net">
  <diagram name="Registration Process (expanded)" id="reg-expanded">
    <mxGraphModel><root>
      <mxCell id="0"/>
      <mxCell id="1" parent="0"/>
      <!-- Actors + Flow -->
      <mxCell id="3002" value="User / Client (POST /api/register)" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="40" y="40" width="220" height="60" as="geometry"/></mxCell>
      <mxCell id="3003" value="RegistrationController" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1"><mxGeometry x="300" y="40" width="220" height="60" as="geometry"/></mxCell>
      <mxCell id="3004" value="Validate DTO (@Valid)\nChecks: name, email, password, phone" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="560" y="40" width="260" height="60" as="geometry"/></mxCell>
      <mxCell id="3005" value="RegistrationService\n(business rules)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6f7ff;strokeColor=#4da6ff;" vertex="1" parent="1"><mxGeometry x="860" y="20" width="260" height="60" as="geometry"/></mxCell>
      <mxCell id="3006" value="Password hashing (BCrypt)\nAssign default roles" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="1160" y="20" width="220" height="60" as="geometry"/></mxCell>
      <mxCell id="3007" value="User Entity" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="1160" y="120" width="220" height="60" as="geometry"/></mxCell>
      <mxCell id="3008" value="Database (users table)" style="ellipse;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="1420" y="120" width="220" height="60" as="geometry"/></mxCell>
      <mxCell id="3009" value="Publish UserRegisteredEvent" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f4f4f4;strokeColor=#999999;" vertex="1" parent="1"><mxGeometry x="300" y="140" width="300" height="60" as="geometry"/></mxCell>
      <mxCell id="3010" value="Email Verification Listener\n(sends verification email with token)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#c9daf8;strokeColor=#3c78d8;" vertex="1" parent="1"><mxGeometry x="640" y="140" width="320" height="60" as="geometry"/></mxCell>
      <mxCell id="3011" value="Welcome Flow Listener\n(assign initial onboarding tasks)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d9ead3;strokeColor=#38761d;" vertex="1" parent="1"><mxGeometry x="980" y="220" width="320" height="60" as="geometry"/></mxCell>
      <mxCell id="3012" value="Verification Token Table\n(user_id, token, expires_at)" style="rounded=1;whiteSpace=wrap;html=1;" vertex="1" parent="1"><mxGeometry x="1420" y="220" width="260" height="60" as="geometry"/></mxCell>
      <mxCell id="3013" value="Error response (400/422)\nReturn validation errors" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffebeb;strokeColor=#d9534f;" vertex="1" parent="1"><mxGeometry x="300" y="260" width="300" height="60" as="geometry"/></mxCell>
      <!-- Developer notes -->
      <mxCell id="3014" value="Developer notes:\n- Controller: RegistrationController.createUser(RegistrationRequest) using @Valid DTO\n- Service: RegistrationService handles business rules, hashing and saving via UserRepository\n- Transaction: save user then publish event; listeners should be @TransactionalEventListener(AFTER_COMMIT)\n- Email verification: persist verification token and send link: /verify?token=...\n- Security: store passwords hashed (BCrypt), do not return password fields in responses\n- Files: RegistrationController.java, RegistrationService.java, User.java, UserRepository.java, UserRegisteredEvent.java, EmailVerificationListener.java, VerificationToken.java (entity)\n- Tests: unit tests for validation, integration test for end-to-end registration + email listener (use test email or mock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f7f7f7;strokeColor=#bbbbbb;" vertex="1" parent="1"><mxGeometry x="40" y="340" width="1640" height="220" as="geometry"/></mxCell>
      <!-- Arrows and labels -->
      <mxCell id="3015" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3002" target="3003"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3016" value="POST body -> RegistrationRequest" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3003" target="3004"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3017" value="if valid -> call service" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3004" target="3005"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3018" value="hash password, assign roles" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3005" target="3006"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3019" value="map -> entity" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3006" target="3007"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3020" value="save" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3007" target="3008"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3021" value="publish (AFTER_COMMIT)" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3008" target="3009"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3022" value="async -> send verification email" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;strokeColor=#3c78d8;" edge="1" parent="1" source="3009" target="3010"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3023" value="async -> onboarding tasks" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;strokeColor=#38761d;" edge="1" parent="1" source="3009" target="3011"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3024" value="store token" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;" edge="1" parent="1" source="3010" target="3012"><mxGeometry relative="1" as="geometry"/></mxCell>
      <mxCell id="3025" value="on validation error" style="edgeStyle=elbowEdgeStyle;endArrow=block;html=1;strokeColor=#d9534f;" edge="1" parent="1" source="3004" target="3013"><mxGeometry relative="1" as="geometry"/></mxCell>
    </root></mxGraphModel>
  </diagram>
</mxfile>